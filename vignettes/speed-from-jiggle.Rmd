---
title: "Estimating Forward Speed from Accelerometer Jiggle"
author: "Max Czapanskiy"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 6,
  dpi = 220,
  out.width = "650px",
  warning = FALSE,
  message = FALSE
)
```

The speed of an animal is an important quantity in understanding energetics, biomechanics, and fine-scale predator-prey interactions. Animal-attached devices, also called tags or bio-loggers, have limited ability to measure speed directly. However, in aquatic environments, the signal noise in high sampling rate accelerometers (the "jiggle") grows exponentially with forward speed. Regressing known speeds against the magnitude of the jiggle allows one to estimate the animal's speed during the entire deployment. For more details, see: 

Cade, D. E., Barr, K. R., Calambokidis, J., Friedlaender, A. S. & Goldbogen, J. A. Determining forward speed from accelerometer jiggle in aquatic environments. *Journal of Experimental Biology* **221**, jeb170449 (2018).

## Calculating known speed

The first step in estimating speed for the entire deployment is identifying periods of known speed. During steep descents, the change in depth multiplied by the sine of the animal's pitch (orientation-corrected depth rate, OCDR) is a good approximation of forward speed. `jgl_desc` and `jgl_ocdr` find steep descent periods and calculate OCDR. If you have `cowplot` installed, you can use `plot_desc` and `plot_ocdr` to visualize the results. Here's an example using example data from a blue whale tagged in Monterey Bay in 2016.

```{r desc}
library(jiggle)
desc <- jgl_desc(prh_expl)
plot_desc(desc)
```

`jgl_desc` identifies steep descents using two thresholds: `depth_thr` and `pitch_thr`. By default, these thresholds are set to 5 m and -45 degrees. You can use even steeper sections with a more aggressive pitch threshold, which will reduce the length of the descent phases. Note, `jgl_desc` assumes pitch is negative during descent.

```{r steeper_desc}
library(dplyr)
desc_steeper <- jgl_desc(prh_expl, pitch_thr = -60 * pi/180)
# Use the `desc_id` column to compare the duration of descent phases
desc %>% 
  group_by(desc_id) %>% 
  filter(!is.na(desc_id)) %>% 
  summarize(desc_start = min(time),
            desc_end = max(time),
            desc_dur = as.numeric(desc_end - desc_start, unit = "secs"))
desc_steeper %>% 
  filter(!is.na(desc_id)) %>% 
  group_by(desc_id) %>% 
  summarize(desc_start = min(time),
            desc_end = max(time),
            desc_dur = as.numeric(desc_end - desc_start, unit = "secs"))
plot_desc(desc_steeper)
```

Increasing the pitch threshold to 60 degrees reduced the durations of the two descents by about 20 s each.
